#cloud-config
# Purple Computer Autoinstall Configuration
# This file drives the automated Ubuntu Server installation
#
# Architecture: Ubuntu Server + minimal Xorg (no desktop environment) + kitty fullscreen
# No GUI, no window manager, no desktop bloat - just a fullscreen terminal

autoinstall:
  version: 1

  # Early commands run before installation begins
  early-commands:
    - echo "Starting Purple Computer installation..."
    # Stop snapd to avoid overlayfs conflicts
    - systemctl stop snapd.socket snapd.service || true
    - systemctl mask snapd.socket snapd.service || true

  # Locale and keyboard settings
  locale: en_US.UTF-8
  keyboard:
    layout: us

  # Network configuration - disabled by default for safety
  network:
    version: 2
    ethernets:
      any:
        match:
          name: en*
        dhcp4: false
        dhcp6: false

  # Storage configuration - use entire disk
  storage:
    layout:
      name: lvm
      sizing-policy: all

  # Identity - creates the purple user
  # NOTE: User will have NO PASSWORD (account is locked, auto-login only)
  # Parent mode is protected by a separate parent password set on first use
  identity:
    hostname: purplecomputer
    username: purple
    password: "$6$locked$locked"
    # Password is locked - no login via password possible
    # System uses auto-login on TTY1
    # Parent mode uses separate password stored in ~/.purple/parent.json

  # SSH disabled for security
  ssh:
    install-server: false

  # Package selection
  # IMPORTANT: Ubuntu Server base, NO desktop environment packages
  packages:
    # X11 minimal (just the X server, no window manager, no desktop environment)
    - xorg
    - xinit
    - xserver-xorg-video-all

    # Terminal emulator (runs fullscreen via xinitrc)
    - kitty

    # Python environment
    - python3
    - python3-pip
    - python3-venv
    - ipython3

    # Text-to-speech
    - espeak-ng
    - python3-pyttsx3

    # Audio
    - alsa-utils
    - pulseaudio

    # Fonts and emoji
    - fonts-noto
    - fonts-noto-color-emoji
    - fonts-dejavu

    # Utilities
    - git
    - curl
    - wget
    - vim
    - less

    # Build tools for Python packages
    - build-essential
    - python3-dev

  # Disable automatic updates for stability
  updates: security

  # User data - additional cloud-init configuration
  user-data:
    # Disable automatic updates completely
    package_update: false
    package_upgrade: false

    # Run commands after user creation
    runcmd:
      - echo "Purple Computer post-install configuration..."

      # Install Python packages (including new dependencies)
      - pip3 install --system colorama termcolor pillow packaging

      # Lock the purple user account (no password login)
      - passwd -l purple

      # Create Purple Computer directory structure
      - mkdir -p /home/purple/.purple/modes
      - mkdir -p /home/purple/.purple/packs
      - mkdir -p /home/purple/.config/kitty
      - mkdir -p /usr/share/purple

      # Create legacy kiduser for backwards compatibility
      - useradd -m -s /bin/bash kiduser || true
      - passwd -l kiduser
      - mkdir -p /home/kiduser/.purple/modes
      - mkdir -p /home/kiduser/.purple/packs
      - mkdir -p /home/kiduser/.config/kitty

      # Set ownership
      - chown -R purple:purple /home/purple/.purple
      - chown -R purple:purple /home/purple/.config
      - chown -R kiduser:kiduser /home/kiduser/.purple || true
      - chown -R kiduser:kiduser /home/kiduser/.config || true

      # Setup virtio-fs shared folder for VM development
      # This allows mounting host directories in the VM for live code editing
      - mkdir -p /mnt/purple
      - |
        cat >> /etc/fstab <<'FSTAB_EOF'
        # Purple Computer shared folder (virtio-fs for VM testing)
        purple /mnt/purple virtiofs defaults,nofail 0 0
        FSTAB_EOF
      - mount -a 2>/dev/null || true

      # Disable unnecessary services
      - systemctl disable systemd-networkd-wait-online.service
      - systemctl disable NetworkManager.service
      - systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target

      # Configure audio
      - usermod -a -G audio purple
      - usermod -a -G audio kiduser || true

      # Final message
      - echo "Purple Computer installation complete!"

  # Late commands - run after installation, before reboot
  late-commands:
    # Copy Purple Computer files to staging area (avoid overlayfs conflicts)
    - mkdir -p /target/opt/purple_install
    - |
      if [ -d /cdrom/purple_files ]; then
        cp -r /cdrom/purple_files /target/opt/purple_install/ || true
      fi

    # Create first-boot setup service that will run on initial boot
    - |
      cat > /target/etc/systemd/system/purple-first-boot.service <<'EOF'
      [Unit]
      Description=Purple Computer First Boot Setup
      After=network.target
      ConditionPathExists=/opt/purple_install/purple_files

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/usr/local/bin/purple-first-boot.sh

      [Install]
      WantedBy=multi-user.target
      EOF

    # Create first-boot setup script
    - |
      cat > /target/usr/local/bin/purple-first-boot.sh <<'FIRSTBOOT'
      #!/bin/bash
      set -e

      echo "Purple Computer First Boot Setup..."

      # Copy Purple Computer files to purple user
      if [ -d /opt/purple_install/purple_files ]; then
        mkdir -p /home/purple/.purple
        cp -r /opt/purple_install/purple_files/* /home/purple/.purple/
        chown -R purple:purple /home/purple/.purple
        find /home/purple/.purple -name "*.py" -type f -exec chmod +x {} \;

        # Copy to kiduser for backwards compatibility
        if [ -d /home/kiduser ]; then
          mkdir -p /home/kiduser/.purple
          cp -r /opt/purple_install/purple_files/* /home/kiduser/.purple/
          chown -R kiduser:kiduser /home/kiduser/.purple
          find /home/kiduser/.purple -name "*.py" -type f -exec chmod +x {} \;
        fi
      fi

      # Setup getty auto-login
      if [ -f /opt/purple_install/purple_files/systemd/getty-override.conf ]; then
        mkdir -p /etc/systemd/system/getty@tty1.service.d
        cp /opt/purple_install/purple_files/systemd/getty-override.conf /etc/systemd/system/getty@tty1.service.d/override.conf
        systemctl daemon-reload
        systemctl enable getty@tty1.service
      fi

      # Copy xinitrc
      if [ -f /opt/purple_install/purple_files/xinitrc ]; then
        cp /opt/purple_install/purple_files/xinitrc /home/purple/.xinitrc
        chown purple:purple /home/purple/.xinitrc
        chmod +x /home/purple/.xinitrc
        if [ -d /home/kiduser ]; then
          cp /opt/purple_install/purple_files/xinitrc /home/kiduser/.xinitrc
          chown kiduser:kiduser /home/kiduser/.xinitrc
          chmod +x /home/kiduser/.xinitrc
        fi
      fi

      # Copy kitty config
      if [ -f /opt/purple_install/purple_files/kitty.conf ]; then
        mkdir -p /home/purple/.config/kitty
        cp /opt/purple_install/purple_files/kitty.conf /home/purple/.config/kitty/kitty.conf
        chown -R purple:purple /home/purple/.config
        if [ -d /home/kiduser ]; then
          mkdir -p /home/kiduser/.config/kitty
          cp /opt/purple_install/purple_files/kitty.conf /home/kiduser/.config/kitty/kitty.conf
          chown -R kiduser:kiduser /home/kiduser/.config
        fi
      fi

      # Setup auto-startx in .bash_profile
      cat >> /home/purple/.bash_profile <<'BASHEOF'
      # Purple Computer auto-start X11
      if [ -z "$DISPLAY" ] && [ "$XDG_VTNR" = "1" ]; then
        exec startx
      fi
      BASHEOF
      chown purple:purple /home/purple/.bash_profile

      if [ -d /home/kiduser ]; then
        cat >> /home/kiduser/.bash_profile <<'BASHEOF'
      # Purple Computer auto-start X11
      if [ -z "$DISPLAY" ] && [ "$XDG_VTNR" = "1" ]; then
        exec startx
      fi
      BASHEOF
        chown kiduser:kiduser /home/kiduser/.bash_profile
      fi

      # Final ownership fix
      chown -R purple:purple /home/purple
      chown -R kiduser:kiduser /home/kiduser 2>/dev/null || true

      # Clean up staging area
      rm -rf /opt/purple_install

      # Disable this service after first run
      systemctl disable purple-first-boot.service

      echo "Purple Computer first boot setup complete!"
      FIRSTBOOT

    - chmod +x /target/usr/local/bin/purple-first-boot.sh
    - chroot /target systemctl enable purple-first-boot.service

    # Set GRUB timeout to 1 second for fast boot
    - curtin in-target --target=/target -- sed -i 's/GRUB_TIMEOUT=.*/GRUB_TIMEOUT=1/' /etc/default/grub
    - curtin in-target --target=/target -- update-grub

    - echo "Purple Computer late commands complete!"

  # Automatically reboot after installation
  shutdown: reboot
