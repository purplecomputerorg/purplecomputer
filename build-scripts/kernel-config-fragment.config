# PurpleOS Custom Kernel Configuration Fragment
# Module-free architecture: All essential drivers built-in (CONFIG_*=y)
#
# RATIONALE: Runtime kernel modules create fragility:
# - ABI mismatches between kernel and modules
# - Missing dependencies and unknown symbols
# - Incorrect insmod ordering
# - Compressed .ko.zst handling issues
# - Dependency on VM-specific drivers (CD-ROM/sr0)
#
# This config compiles all essential storage and filesystem drivers
# directly into the kernel, eliminating runtime module loading entirely.
# Target: Consumer laptops from 2010+, tested on real hardware, not QEMU.

# =============================================================================
# BLOCK LAYER (Required for all disk I/O)
# =============================================================================
CONFIG_BLOCK=y                          # Block device support (fundamental)
CONFIG_BLK_DEV=y                        # Block device drivers
CONFIG_BLK_DEV_LOOP=y                   # Loop device (for mounting installer.ext4)
CONFIG_BLK_DEV_SD=y                     # SCSI disk support (required for SATA/USB)

# =============================================================================
# SCSI SUBSYSTEM (Required even for SATA via libata)
# =============================================================================
CONFIG_SCSI=y                           # SCSI device support
CONFIG_SCSI_MOD=y                       # SCSI core module support
CONFIG_BLK_DEV_SD=y                     # SCSI disk support (sd_mod)
CONFIG_SCSI_COMMON=y                    # Common SCSI code
CONFIG_SCSI_DMA=y                       # SCSI DMA support

# =============================================================================
# ATA/SATA DRIVERS (Modern laptops use AHCI)
# =============================================================================
CONFIG_ATA=y                            # Serial ATA and Parallel ATA drivers
CONFIG_SATA_AHCI=y                      # AHCI SATA controller (most modern laptops)
CONFIG_ATA_PIIX=y                       # Intel PATA/SATA support (older ThinkPads, legacy Intel)
CONFIG_SATA_MOBILE_LPM_POLICY=3         # Link power management (laptop power saving)

# =============================================================================
# NVMe SUPPORT (Modern SSDs, 2015+ laptops)
# =============================================================================
CONFIG_NVME_CORE=y                      # NVMe core support
CONFIG_BLK_DEV_NVME=y                   # NVMe block device driver
CONFIG_NVME_MULTIPATH=y                 # NVMe multipath support

# =============================================================================
# USB SUPPORT (Required for USB boot and USB storage)
# =============================================================================
CONFIG_USB_SUPPORT=y                    # USB support framework
CONFIG_USB=y                            # USB core
CONFIG_USB_ANNOUNCE_NEW_DEVICES=y       # Log USB device connections

# USB Host Controllers (laptop USB ports)
CONFIG_USB_XHCI_HCD=y                   # xHCI (USB 3.0+) - modern laptops
CONFIG_USB_XHCI_PCI=y                   # xHCI PCI glue
CONFIG_USB_EHCI_HCD=y                   # EHCI (USB 2.0) - backward compatibility
CONFIG_USB_EHCI_PCI=y                   # EHCI PCI glue
CONFIG_USB_OHCI_HCD=y                   # OHCI (USB 1.1) - legacy support
CONFIG_USB_UHCI_HCD=y                   # UHCI (USB 1.1 Intel/VIA)

# USB Storage (for USB installer stick)
CONFIG_USB_STORAGE=y                    # USB mass storage (flash drives)
CONFIG_USB_UAS=y                        # USB Attached SCSI (faster USB 3.0 mode)

# =============================================================================
# PARTITION TABLE FORMATS (Required to read disk layouts)
# =============================================================================
CONFIG_PARTITION_ADVANCED=y             # Advanced partition support
CONFIG_MSDOS_PARTITION=y                # MS-DOS/MBR partition tables
CONFIG_EFI_PARTITION=y                  # GPT/EFI partition tables (modern systems)

# =============================================================================
# FILESYSTEMS (Essential for installer operation)
# =============================================================================
CONFIG_EXT4_FS=y                        # ext4 filesystem (installer rootfs, golden image)
CONFIG_EXT4_USE_FOR_EXT2=y              # Use ext4 driver for ext2/ext3
CONFIG_VFAT_FS=y                        # VFAT/FAT32 (USB boot, EFI system partitions)
CONFIG_FAT_FS=y                         # FAT filesystem core
CONFIG_NLS_CODEPAGE_437=y               # DOS codepage 437 (required for FAT)
CONFIG_NLS_ISO8859_1=y                  # Latin-1 charset (required for FAT)

# Pseudo-filesystems (userspace interface)
CONFIG_PROC_FS=y                        # /proc filesystem
CONFIG_SYSFS=y                          # /sys filesystem
CONFIG_DEVTMPFS=y                       # /dev device manager
CONFIG_DEVTMPFS_MOUNT=y                 # Auto-mount /dev at boot

# =============================================================================
# STORAGE MULTIPLEXING (Device mapper, LVM)
# =============================================================================
CONFIG_MD=y                             # Multiple device support (RAID/LVM)
CONFIG_BLK_DEV_DM=y                     # Device mapper (required for LVM)
CONFIG_DM_CRYPT=y                       # dm-crypt (optional: disk encryption support)

# =============================================================================
# EFI SUPPORT (Modern UEFI boot)
# =============================================================================
CONFIG_EFI=y                            # EFI runtime services
CONFIG_EFI_STUB=y                       # EFI stub (direct kernel boot from UEFI)
CONFIG_EFI_VARS=y                       # EFI variable support
CONFIG_FB_EFI=y                         # EFI framebuffer (early console)

# =============================================================================
# CONSOLE/TTY (Required for installer TUI)
# =============================================================================
CONFIG_TTY=y                            # TTY support
CONFIG_VT=y                             # Virtual terminal
CONFIG_VT_CONSOLE=y                     # VT console
CONFIG_VT_HW_CONSOLE_BINDING=y          # Hardware console binding (for VT switching)
CONFIG_FRAMEBUFFER_CONSOLE=y            # Framebuffer console

# =============================================================================
# INPUT SUBSYSTEM (Required for keyboard - VT switching, installer interaction)
# =============================================================================
# Core input layer
CONFIG_INPUT=y                          # Generic input layer (fundamental)
CONFIG_INPUT_EVDEV=y                    # Event device interface (/dev/input/eventX)

# Keyboard support (PS/2 - built into most laptops)
CONFIG_INPUT_KEYBOARD=y                 # Keyboard support
CONFIG_KEYBOARD_ATKBD=y                 # AT keyboard (PS/2, internal laptop keyboards)

# Serial I/O (connects PS/2 keyboards/touchpads to input layer)
CONFIG_SERIO=y                          # Serial I/O support
CONFIG_SERIO_I8042=y                    # i8042 PC keyboard controller (standard on all PCs)
CONFIG_SERIO_LIBPS2=y                   # PS/2 driver library

# Mouse/touchpad support (PS/2 touchpads on laptops)
CONFIG_INPUT_MOUSE=y                    # Mouse support
CONFIG_MOUSE_PS2=y                      # PS/2 mouse/touchpad
CONFIG_MOUSE_PS2_ALPS=y                 # ALPS touchpad
CONFIG_MOUSE_PS2_SYNAPTICS=y            # Synaptics touchpad
CONFIG_MOUSE_PS2_ELANTECH=y             # Elantech touchpad

# HID subsystem (USB keyboards, mice, and some internal laptop devices)
CONFIG_HID_SUPPORT=y                    # HID support
CONFIG_HID=y                            # HID core
CONFIG_HID_GENERIC=y                    # Generic HID driver
CONFIG_USB_HID=y                        # USB HID (keyboards, mice)

# I2C HID (some newer laptops use I2C for touchpad/keyboard)
CONFIG_I2C_HID_CORE=y                   # I2C HID core
CONFIG_I2C_HID_ACPI=y                   # I2C HID ACPI driver

# =============================================================================
# I2C SUPPORT (Required for I2C HID touchpads on modern laptops)
# =============================================================================
CONFIG_I2C=y                            # I2C support
CONFIG_I2C_CHARDEV=y                    # I2C character device interface
CONFIG_I2C_I801=y                       # Intel 82801 (ICH/PCH) - most Intel laptops
CONFIG_I2C_DESIGNWARE_CORE=y            # Synopsys DesignWare I2C
CONFIG_I2C_DESIGNWARE_PLATFORM=y        # DesignWare platform driver

# =============================================================================
# FIRMWARE LOADING (For hardware initialization)
# =============================================================================
CONFIG_FW_LOADER=y                      # Firmware loader
CONFIG_EXTRA_FIRMWARE=""                # (Loaded from rootfs /lib/firmware)

# =============================================================================
# GENERAL SETUP (Kernel fundamentals)
# =============================================================================
CONFIG_64BIT=y                          # 64-bit kernel (x86_64)
CONFIG_X86_64=y                         # x86-64 architecture
CONFIG_SMP=y                            # Symmetric multiprocessing
CONFIG_HOTPLUG_CPU=y                    # CPU hotplug support
CONFIG_PCI=y                            # PCI bus support
CONFIG_ACPI=y                           # ACPI support (laptop power management)

# =============================================================================
# NOTES FOR MAINTAINERS
# =============================================================================
# To apply this config fragment during kernel build:
#   1. Start with Ubuntu's generic config: make defconfig
#   2. Merge this fragment: scripts/kconfig/merge_config.sh .config kernel-config-fragment.config
#   3. Build kernel: make -j$(nproc) bzImage
#
# This eliminates the need for:
#   - insmod/modprobe in initramfs
#   - /lib/modules/* in initramfs
#   - Module dependency resolution
#   - .ko.zst decompression
#   - CD-ROM/isofs drivers (no longer needed for USB boot)
#
# Compatibility tested on:
#   - ThinkPad T-series (2010-2020)
#   - Dell Latitude (2012+)
#   - HP EliteBook (2013+)
#   - Generic consumer laptops with SATA, NVMe, or USB boot
