#!/bin/bash
# Purple Computer X11 Startup Script
# This launches when the purple user logs in and starts X11

# Wait a moment for X to fully initialize
sleep 1

# Disable screen blanking and power management
xset s off
xset -dpms
xset s noblank

# Disable bell
xset b off

# Set keyboard repeat rate (faster for kid typing)
xset r rate 300 30

# Hide mouse cursor after 2 seconds of inactivity
# (kids often don't use mouse in terminal)
if command -v unclutter &> /dev/null; then
    unclutter -idle 2 &
fi

# Start SPICE guest agent for VM display resize (harmless on real hardware)
if command -v spice-vdagent &> /dev/null; then
    spice-vdagent &
fi

# Set the purple background color (brand identity - fills screen outside 10Ã—6" viewport)
xsetroot -solid "#2d1b4e"

# Launch matchbox window manager (minimal WM for proper fullscreen support)
matchbox-window-manager -use_titlebar no &

# Wait for WM to start
sleep 0.5

# Calculate optimal font size for this screen (10x6 inch content area)
FONT_SIZE=$(python3 /opt/purple/calc_font_size.py 2>/dev/null || echo "18.0")

# Log startup for debugging
exec >> /tmp/xinitrc.log 2>&1
echo "=== $(date) ==="
echo "Starting Alacritty with font size $FONT_SIZE"
echo "Config: /etc/purple/alacritty.toml"
echo "Command: /usr/local/bin/purple"

# Launch Alacritty in fullscreen with Purple Computer TUI
alacritty --config-file /etc/purple/alacritty.toml \
    -o "font.size=${FONT_SIZE}" \
    -e /usr/local/bin/purple
ALACRITTY_EXIT=$?

echo "Alacritty exited with code $ALACRITTY_EXIT"

# If Alacritty exited (any code), show debug info
# This catches both failures AND unexpected clean exits
echo "Trying Alacritty with bash fallback..."
exec alacritty --config-file /etc/purple/alacritty.toml \
    -o "font.size=${FONT_SIZE}" \
    -e bash -c "echo '=== Purple TUI Debug ==='; echo 'Alacritty exit code: $ALACRITTY_EXIT'; echo ''; echo '--- stderr log ---'; cat /tmp/purple-stderr.log 2>/dev/null || echo '(no stderr log)'; echo ''; echo '--- xinitrc log ---'; cat /tmp/xinitrc.log 2>/dev/null || echo '(no xinitrc log)'; echo ''; echo 'Type commands or press Ctrl+D to exit X'; bash"
