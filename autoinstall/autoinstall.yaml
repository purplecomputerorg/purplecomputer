#cloud-config
# Purple Computer Autoinstall Configuration
# This file drives the automated Ubuntu Server installation
#
# Architecture: Ubuntu Server + minimal Xorg (no desktop environment) + kitty fullscreen
# No GUI, no window manager, no desktop bloat - just a fullscreen terminal

autoinstall:
  version: 1

  # Early commands run before installation begins
  early-commands:
    - echo "Starting Purple Computer installation..."

  # Locale and keyboard settings
  locale: en_US.UTF-8
  keyboard:
    layout: us

  # Network configuration - enabled for auto-updates and pack downloads
  # Parents can manage network access via router/firewall or parent mode settings
  network:
    version: 2
    ethernets:
      any:
        match:
          name: en*
        dhcp4: true
        dhcp6: false

  # Storage configuration - use entire disk
  storage:
    layout:
      name: lvm
      sizing-policy: all

  # Identity - creates the purple user
  # NOTE: User will have NO PASSWORD (account is locked, auto-login only)
  # Parent mode is protected by a separate parent password set on first use
  identity:
    hostname: purplecomputer
    username: purple
    password: "$6$locked$locked"
    # Password is locked - no login via password possible
    # System uses auto-login on TTY1
    # Parent mode uses separate password stored in ~/.purple/parent.json

  # SSH disabled for security
  ssh:
    install-server: false

  # Package selection
  # IMPORTANT: Ubuntu Server base, NO desktop environment packages
  packages:
    # X11 minimal (just the X server, no window manager, no desktop environment)
    - xorg
    - xinit
    - xserver-xorg-video-all
    - matchbox-window-manager

    # Terminal emulator (runs fullscreen via xinitrc)
    - kitty

    # Python environment
    - python3
    - python3-pip
    - python3-venv
    - ipython3

    # Text-to-speech
    - espeak-ng
    # pyttsx3 installed via pip in runcmd (not in apt repos for Ubuntu 24.04)

    # Audio
    - alsa-utils
    - pulseaudio

    # Fonts and emoji
    - fonts-noto
    - fonts-noto-color-emoji
    - fonts-dejavu

    # Utilities
    - git
    - curl
    - wget
    - vim
    - less

    # Build tools for Python packages
    - build-essential
    - python3-dev

    # Mac hardware support (2012-2017 Intel Macs)
    # Broadcom WiFi firmware for common Mac WiFi chips
    - bcmwl-kernel-source
    - firmware-b43-installer
    - b43-fwcutter

    # WiFi tools for wpa_supplicant-based setup
    - wpasupplicant
    - wireless-tools
    - iw
    - rfkill

  # Disable automatic updates for stability
  updates: security

  # User data - additional cloud-init configuration
  user-data:
    # Disable automatic updates completely
    package_update: false
    package_upgrade: false

    # Run commands after user creation
    runcmd:
      - echo "Purple Computer post-install configuration..."

      # Install Python packages (including new dependencies)
      - pip3 install --system colorama termcolor pillow packaging pyttsx3

      # Lock the purple user account (no password login)
      - passwd -l purple

      # Create Purple Computer directory structure
      - mkdir -p /home/purple/.purple/modes
      - mkdir -p /home/purple/.purple/packs
      - mkdir -p /home/purple/.config/kitty
      - mkdir -p /usr/share/purple

      # Create legacy kiduser for backwards compatibility
      - useradd -m -s /bin/bash kiduser || true
      - passwd -l kiduser
      - mkdir -p /home/kiduser/.purple/modes
      - mkdir -p /home/kiduser/.purple/packs
      - mkdir -p /home/kiduser/.config/kitty

      # Set ownership - IMPORTANT: fix /home/purple itself first, then subdirectories
      - sh -c 'if id purple >/dev/null 2>&1; then chown purple:purple /home/purple; chown -R purple:purple /home/purple/.purple; chown -R purple:purple /home/purple/.config; fi'
      - sh -c 'if id kiduser >/dev/null 2>&1; then chown kiduser:kiduser /home/kiduser; chown -R kiduser:kiduser /home/kiduser/.purple; chown -R kiduser:kiduser /home/kiduser/.config; fi'

      # Disable unnecessary services (NetworkManager stays enabled for auto-updates)
      - systemctl disable systemd-networkd-wait-online.service
      - systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target

      # Configure audio
      - usermod -a -G audio purple
      - usermod -a -G audio kiduser || true

      # Final message
      - echo "Purple Computer installation complete!"

  # Late commands - run after installation, before reboot
  # NO file copying from /cdrom to avoid overlayfs conflicts with subiquity snap
  late-commands:
    # Setup getty auto-login NOW (before first boot) so it works immediately
    - mkdir -p /target/etc/systemd/system/getty@tty1.service.d
    - |
      cat > /target/etc/systemd/system/getty@tty1.service.d/override.conf <<'GETTY'
      # Getty Auto-Login Override for Purple Computer
      [Service]
      ExecStart=
      ExecStart=-/sbin/agetty --autologin purple --noclear %I $TERM
      StandardInput=tty
      StandardOutput=tty
      GETTY

    # Create first-boot setup service (blocks getty until setup completes)
    - |
      cat > /target/etc/systemd/system/purple-first-boot.service <<'EOF'
      [Unit]
      Description=Purple Computer First Boot Setup
      After=network-online.target systemd-user-sessions.service
      Before=getty@tty1.service
      Wants=network-online.target
      ConditionPathExists=!/etc/purple-computer-configured
      DefaultDependencies=no

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/usr/local/bin/purple-first-boot.sh
      StandardOutput=journal+console
      StandardError=journal+console

      [Install]
      WantedBy=multi-user.target
      EOF

    # Create first-boot setup script (embeds all configs inline)
    - |
      cat > /target/usr/local/bin/purple-first-boot.sh <<'FIRSTBOOT'
      #!/bin/bash
      set -e

      echo ""
      echo "=========================================="
      echo "  Purple Computer First Boot Setup"
      echo "=========================================="
      echo ""
      echo "Setting up Purple Computer for the first time..."
      echo "This will take about 1-2 minutes."
      echo ""

      # Clone Purple Computer repository
      echo "Downloading Purple Computer files..."
      cd /tmp
      if ! git clone https://github.com/purplecomputerorg/purplecomputer.git 2>&1; then
        echo ""
        echo "ERROR: Failed to download Purple Computer files."
        echo "Please check your internet connection and try again."
        echo ""
        echo "Press Enter to get a login prompt..."
        read
        exit 1
      fi
      echo "✓ Download complete"
      echo ""

      # Copy Purple REPL to user directories
      echo "Installing Purple Computer files..."
      mkdir -p /home/purple/.purple
      cp -r /tmp/purplecomputer/purple_repl/* /home/purple/.purple/
      if id purple >/dev/null 2>&1; then
        chown -R purple:purple /home/purple/.purple
      fi
      find /home/purple/.purple -name "*.py" -type f -exec chmod +x {} \;

      # Backwards compatibility with kiduser
      if [ -d /home/kiduser ]; then
        mkdir -p /home/kiduser/.purple
        cp -r /tmp/purplecomputer/purple_repl/* /home/kiduser/.purple/
        chown -R kiduser:kiduser /home/kiduser/.purple
        find /home/kiduser/.purple -name "*.py" -type f -exec chmod +x {} \;
      fi
      echo "✓ Installation complete"
      echo ""

      # Getty auto-login is already configured in late-commands
      # Just ensure it's enabled
      echo "Configuring auto-login..."
      systemctl daemon-reload
      systemctl enable getty@tty1.service
      echo "✓ Auto-login configured"
      echo ""

      # Create xinitrc (embed inline)
      echo "Setting up X11 environment..."
      cat > /home/purple/.xinitrc <<'XINITRC'
      #!/bin/bash
      # Purple Computer X11 Startup
      xset s off
      xset -dpms
      xset s noblank
      xset b off
      xset r rate 300 30
      xsetroot -solid "#800080"
      matchbox-window-manager &
      exec kitty --start-as=fullscreen --single-instance /home/purple/.purple/repl.py
      XINITRC

      if id purple >/dev/null 2>&1; then
        chown purple:purple /home/purple/.xinitrc
        chmod +x /home/purple/.xinitrc
      fi

      if [ -d /home/kiduser ]; then
        cp /home/purple/.xinitrc /home/kiduser/.xinitrc
        chown kiduser:kiduser /home/kiduser/.xinitrc
        chmod +x /home/kiduser/.xinitrc
      fi

      # Create kitty config (embed inline)
      mkdir -p /home/purple/.config/kitty
      cat > /home/purple/.config/kitty/kitty.conf <<'KITTY'
      # Purple Computer Kitty Configuration
      font_family      monospace
      font_size        14.0
      cursor_blink_interval 0
      enable_audio_bell no
      window_padding_width 10
      background_opacity 1.0
      background #1a1a2e
      foreground #eee8d5
      KITTY

      if id purple >/dev/null 2>&1; then
        chown -R purple:purple /home/purple/.config
      fi

      if [ -d /home/kiduser ]; then
        mkdir -p /home/kiduser/.config/kitty
        cp /home/purple/.config/kitty/kitty.conf /home/kiduser/.config/kitty/kitty.conf
        chown -R kiduser:kiduser /home/kiduser/.config
      fi

      # Setup auto-startx in .bash_profile
      echo "Configuring auto-start..."
      cat >> /home/purple/.bash_profile <<'BASHEOF'
      # Purple Computer auto-start X11
      if [ -z "$DISPLAY" ] && [ "$XDG_VTNR" = "1" ]; then
        exec startx
      fi
      BASHEOF
      if id purple >/dev/null 2>&1; then
        chown purple:purple /home/purple/.bash_profile
      fi

      if [ -d /home/kiduser ]; then
        cat >> /home/kiduser/.bash_profile <<'BASHEOF'
      # Purple Computer auto-start X11
      if [ -z "$DISPLAY" ] && [ "$XDG_VTNR" = "1" ]; then
        exec startx
      fi
      BASHEOF
        chown kiduser:kiduser /home/kiduser/.bash_profile
      fi
      echo "✓ Auto-start configured"
      echo ""

      echo "✓ Xorg environment configured"
      echo ""

      # Mac hardware support - load hid-apple for keyboards/trackpads
      echo "Configuring Mac hardware support..."
      if lsmod | grep -q hid_apple || modinfo hid_apple >/dev/null 2>&1; then
        echo "hid_apple" >> /etc/modules
        # Enable function keys as standard F1-F12 by default
        echo "options hid_apple fnmode=2" > /etc/modprobe.d/hid_apple.conf
        echo "✓ Mac keyboard/trackpad support enabled"
      fi
      echo ""

      # Final ownership fix (CRITICAL for .Xauthority and X11 logs)
      echo "Finalizing setup..."
      # Fix home directories themselves first (prevents X11 permission errors)
      if id purple >/dev/null 2>&1; then
        chown purple:purple /home/purple
        chown -R purple:purple /home/purple
      fi
      if id kiduser >/dev/null 2>&1; then
        chown kiduser:kiduser /home/kiduser
        chown -R kiduser:kiduser /home/kiduser
      fi

      # Clean up staging area
      rm -rf /opt/purple_install
      rm -rf /tmp/purplecomputer

      # Mark as configured and disable this service
      touch /etc/purple-computer-configured
      systemctl disable purple-first-boot.service

      echo "✓ Setup complete"
      echo ""
      echo "=========================================="
      echo "  Purple Computer is ready!"
      echo "=========================================="
      echo ""
      echo "Starting Purple Computer..."
      sleep 2
      FIRSTBOOT

    - chmod +x /target/usr/local/bin/purple-first-boot.sh
    - chroot /target systemctl enable purple-first-boot.service

    # Set GRUB timeout to 1 second for fast boot
    - curtin in-target --target=/target -- sed -i 's/GRUB_TIMEOUT=.*/GRUB_TIMEOUT=1/' /etc/default/grub
    - curtin in-target --target=/target -- update-grub

    - echo "Purple Computer late commands complete!"

  # Automatically reboot after installation
  shutdown: reboot
