#!/bin/bash
# Create default user account for Purple Computer
# Runs in FAI chroot environment

set -e

error=0 ; trap 'error=$(($?>$error?$?:$error))' ERR

# Default user configuration
USERNAME="purple"
FULLNAME="Purple Computer User"
SHELL="/bin/bash"

echo "Creating user account: $USERNAME"

# Create user with home directory
$ROOTCMD useradd -m -s $SHELL -c "$FULLNAME" -G sudo,audio,video,plugdev,netdev,bluetooth $USERNAME

# Set default password (user should change this)
# Default password: "purple" - CHANGE THIS IN PRODUCTION
echo "$USERNAME:purple" | $ROOTCMD chpasswd

# Create user directories
$ROOTCMD mkdir -p /home/$USERNAME/{Documents,Downloads,Pictures,Music,Videos,Projects}
$ROOTCMD chown -R $USERNAME:$USERNAME /home/$USERNAME

# Set proper permissions
$ROOTCMD chmod 755 /home/$USERNAME

# Add user to additional groups for hardware access
$ROOTCMD usermod -a -G lp $USERNAME || true
$ROOTCMD usermod -a -G scanner $USERNAME || true
$ROOTCMD usermod -a -G dialout $USERNAME || true

# Create .bashrc
cat > $target/home/$USERNAME/.bashrc <<'EOF'
# Purple Computer .bashrc

# If not running interactively, don't do anything
case $- in
    *i*) ;;
      *) return;;
esac

# History settings
HISTCONTROL=ignoreboth
HISTSIZE=10000
HISTFILESIZE=20000
shopt -s histappend

# Check window size after each command
shopt -s checkwinsize

# Colored prompt
if [ -x /usr/bin/tput ] && tput setaf 1 >&/dev/null; then
    PS1='\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
else
    PS1='\u@\h:\w\$ '
fi

# Enable color support
if [ -x /usr/bin/dircolors ]; then
    test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
    alias ls='ls --color=auto'
    alias grep='grep --color=auto'
fi

# Useful aliases
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'
alias ..='cd ..'
alias ...='cd ../..'

# Enable bash completion
if ! shopt -oq posix; then
  if [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
  elif [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
  fi
fi
EOF

# Create .profile
cat > $target/home/$USERNAME/.profile <<'EOF'
# Purple Computer .profile

# Set PATH
if [ -d "$HOME/bin" ] ; then
    PATH="$HOME/bin:$PATH"
fi

if [ -d "$HOME/.local/bin" ] ; then
    PATH="$HOME/.local/bin:$PATH"
fi

# Source .bashrc if running bash
if [ -n "$BASH_VERSION" ]; then
    if [ -f "$HOME/.bashrc" ]; then
        . "$HOME/.bashrc"
    fi
fi
EOF

# Fix ownership
$ROOTCMD chown $USERNAME:$USERNAME /home/$USERNAME/.bashrc
$ROOTCMD chown $USERNAME:$USERNAME /home/$USERNAME/.profile

echo "User account created successfully."
echo "Default username: $USERNAME"
echo "Default password: purple (CHANGE THIS!)"

exit $error
