#!/bin/bash
# Purple Computer X11 Startup
# Simple and reliable - no edge cases

# Log for debugging (view with: cat /tmp/xinitrc.log)
exec >> /tmp/xinitrc.log 2>&1
echo "=== $(date) ==="

# Wait for X to initialize
sleep 1

# Disable screen blanking
xset s off -dpms s noblank b off

# Keyboard repeat (faster for kids)
xset r rate 300 30

# Hide cursor when idle
command -v unclutter &>/dev/null && unclutter -idle 2 &

# SPICE agent for VM resize (harmless on real hardware)
command -v spice-vdagent &>/dev/null && spice-vdagent &

# Purple background (fills space around viewport)
xsetroot -solid "#2d1b4e"

# Window manager (required for fullscreen)
matchbox-window-manager -use_titlebar no &
sleep 0.5

# Prevent HiDPI scaling surprises
export WINIT_X11_SCALE_FACTOR=1.0

# Calculate font size (simple: 80% of screen, clamped to 12-32pt)
FONT_SIZE=$(python3 /opt/purple/calc_font_size.py 2>/dev/null || echo "16")
echo "Font size: $FONT_SIZE"

# Launch Purple Computer
alacritty --config-file /etc/purple/alacritty.toml \
    -o "font.size=${FONT_SIZE}" \
    -e /usr/local/bin/purple

# If it exits, show debug info
echo "Exited, showing debug shell"
exec alacritty --config-file /etc/purple/alacritty.toml \
    -o "font.size=16" \
    -e bash -c "echo 'Purple exited. Debug:'; python3 /opt/purple/calc_font_size.py --info; echo; cat /tmp/xinitrc.log; read"
